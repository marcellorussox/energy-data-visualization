# Energy Data Visualization Project

**Author**: Marcello Russo **Date**: `r Sys.Date()`

------------------------------------------------------------------------

## Setup

Load libraries and dataset.

```{r setup}
# Load required libraries
library(ggplot2)
library(dplyr)
library(tidytuesdayR)
library(scales)
library(tidyr)
library(forcats)
library(ggrepel)

# Load data
tuesdata <- tidytuesdayR::tt_load(2023, week = 23)

energy_data <- tuesdata$'owid-energy'
energy_data <- energy_data %>%
  filter(
    !grepl("\\(", country),         # esclude "Africa (BP)", ecc.
    !grepl("-", country),           # esclude "IEO - Africa (EIA)", ecc.
    !country %in% c("Africa", "Asia", "Europe", "North America", "South America", "Oceania", "World"),
    !grepl("G7|G20|OECD|OPEC|income|region|Union|BP|EIA|Ember", country)
  )

get_continent <- function(country) {
  europe <- c("Italy", "France", "Germany", "Spain", "Portugal", "Netherlands", "Belgium",
              "Sweden", "Norway", "Finland", "Denmark", "Austria", "Switzerland", "Greece",
              "Ireland", "Poland", "Czechia", "Hungary", "Slovakia", "Slovenia",
              "Croatia", "Romania", "Bulgaria", "Estonia", "Latvia", "Lithuania", "Malta",
              "Cyprus", "Luxembourg", "Iceland", "Albania", "Belarus", "Bosnia and Herzegovina",
              "North Macedonia", "Moldova", "Montenegro", "Serbia", "Ukraine", "United Kingdom")

  asia <- c("China", "Japan", "South Korea", "India", "Indonesia", "Malaysia", "Thailand",
            "Vietnam", "Philippines", "Bangladesh", "Pakistan", "Sri Lanka", "Nepal", "Iran",
            "Iraq", "Israel", "Kazakhstan", "Kuwait", "Kyrgyzstan", "Laos", "Lebanon", "Mongolia",
            "Myanmar", "North Korea", "Oman", "Palestine", "Saudi Arabia", "Singapore", "Syria",
            "Taiwan", "Tajikistan", "Timor", "Turkey", "Turkmenistan", "United Arab Emirates",
            "Uzbekistan", "Yemen", "Armenia", "Georgia", "Azerbaijan", "Jordan", "Qatar", "Bahrain",
            "Afghanistan", "Bhutan", "Maldives", "Thailand")

  africa <- c("South Africa", "Nigeria", "Egypt", "Kenya", "Morocco", "Ghana", "Algeria",
              "Tunisia", "Ethiopia", "Ivory Coast", "Senegal", "Angola", "Botswana", "Cameroon",
              "Congo", "Democratic Republic of Congo", "Gabon", "Gambia", "Guinea", "Guinea-Bissau",
              "Madagascar", "Malawi", "Mali", "Mauritania", "Mauritius", "Mozambique", "Namibia",
              "Niger", "Rwanda", "Seychelles", "Sierra Leone", "Somalia", "Sudan", "Tanzania",
              "Togo", "Uganda", "Zambia", "Zimbabwe", "Benin", "Burkina Faso", "Burundi", "Chad",
              "Comoros", "Djibouti", "Eritrea", "Equatorial Guinea", "Eswatini", "Lesotho",
              "Liberia", "Libya", "Sao Tome and Principe", "South Sudan", "Western Sahara")

  north_america <- c("United States", "Canada", "Mexico", "Bahamas", "Barbados", "Belize",
                     "Costa Rica", "Cuba", "Dominica", "Dominican Republic", "El Salvador",
                     "Grenada", "Guatemala", "Haiti", "Honduras", "Jamaica", "Nicaragua",
                     "Panama", "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines",
                     "Trinidad and Tobago")

  south_america <- c("Brazil", "Argentina", "Chile", "Colombia", "Peru", "Uruguay", "Ecuador",
                     "Paraguay", "Venezuela", "Bolivia", "Guyana", "Suriname")

  oceania <- c("Australia", "New Zealand", "Fiji", "Kiribati", "Marshall Islands", "Micronesia",
               "Nauru", "Palau", "Papua New Guinea", "Samoa", "Solomon Islands", "Tonga",
               "Tuvalu", "Vanuatu")

  if (country %in% europe) {
    return("Europe")
  } else if (country %in% asia) {
    return("Asia")
  } else if (country %in% africa) {
    return("Africa")
  } else if (country %in% north_america) {
    return("North America")
  } else if (country %in% south_america) {
    return("South America")
  } else if (country %in% oceania) {
    return("Oceania")
  } else {
    return("Unknown")
  }
}
```

------------------------------------------------------------------------

## Plot 1: GDP vs. Per Capita Energy Consumption

**Question**: Is there a relationship between GDP and per capita energy consumption?

```{r plot1}
# Data processing corretto
plot1data <- energy_data %>%
  filter(year == 2018) %>%
  mutate(continent = sapply(country, get_continent)) %>%
  filter(continent != "Unknown") %>%
  mutate(
    gdp_per_capita = gdp / population
  ) %>%
  filter(
    !is.na(gdp), 
    !is.na(population),
    !is.na(energy_per_capita),
    !is.na(continent)
  )

# Plot con scala lineare
ggplot(plot1data, aes(x = gdp_per_capita, y = energy_per_capita, color = continent)) +
  geom_point(alpha = 0.8, size = 3) +
  geom_smooth(method = "lm", se = FALSE, color = "black", linetype = "dashed") +
  scale_x_log10(
    name = "GDP per capita (USD, log scale)",
    labels = scales::dollar_format(accuracy = 1),
    breaks = c(200, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000),
    limits = c(200, 150000)
  ) +
  scale_y_log10(
    name = "Energy use per capita (kWh, log scale)",
    labels = scales::comma_format(),
    breaks = c(100, 300, 1000, 3000, 10000, 30000, 100000, 200000),
    limits = c(100, 200000)
  ) +
  scale_color_brewer(palette = "Set1") +
  labs(
    title = "Energy Consumption vs Economic Output (2018)",
    subtitle = "Log-log scale clarifies the power-law distribution",
    color = "Continent"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title.position = "plot",
    plot.margin = margin(1, 1, 1, 1, "cm"),
    axis.title = element_text(face = "bold")
  )

ggsave("plots/energy_gdp_plot.png", width = 10, height = 7, dpi = 300, bg = "white")
```

**Explanation**:\
- We use a **scatter plot** to explore the relationship between GDP and energy consumption.\
- Points are colored by `fossil_share_energy` to show how fossil fuel dependency influences the trend.\
- Outliers (top 10% energy consumers) are labeled using `ggrepel` for clarity.

------------------------------------------------------------------------

## Plot 2: Solar and Wind Energy Leaders

**Question**: Which countries lead in solar and wind energy adoption?

```{r plot2}
# Step 1: dati top 10
top_10 <- energy_data %>%
  filter(year == 2022) %>%
  mutate(
    total_share = solar_share_elec + wind_share_elec
  ) %>%
  filter(!is.na(total_share)) %>%
  slice_max(order_by = total_share, n = 10) %>%
  select(country, solar_share_elec, wind_share_elec, total_share)

# Step 2: long format
top_10_long <- top_10 %>%
  pivot_longer(
    cols = c(solar_share_elec, wind_share_elec, total_share),
    names_to = "source",
    values_to = "value"
  ) %>%
  mutate(
    source = recode(source,
                    "solar_share_elec" = "Solar",
                    "wind_share_elec" = "Wind",
                    "total_share" = "Total")
  )

# Step 3: assegnare y numerico per posizionamento perfetto
top_10_long <- top_10_long %>%
  mutate(country = factor(country, levels = top_10$country[order(top_10$total_share)])) %>%
  mutate(y_numeric = as.numeric(country)) %>%
  mutate(y_offset = case_when(
    source == "Solar" ~ y_numeric + 0.2,
    source == "Wind"  ~ y_numeric,
    source == "Total" ~ y_numeric - 0.2
  ))

# Step 4: plot
ggplot(top_10_long, aes(x = value, y = y_offset, color = source)) +
  geom_segment(aes(x = 0, xend = value, y = y_offset, yend = y_offset), linewidth = 0.7) +
  geom_point(size = 3) +
  scale_y_continuous(
    breaks = 1:10,
    labels = levels(top_10_long$country),
    expand = expansion(add = 0.5)
  ) +
  scale_color_brewer(palette = "Dark2") +
  labs(
    title = "Top 10 Countries in Share of Renewable Energy (2022)",
    x = "Share of electricity (%)",
    y = NULL,
    color = "Source"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text.y = element_text(face = "bold"),
    plot.title = element_text(face = "bold")
  )

ggsave("plots/renawable_share_top10.png", width = 10, height = 7, dpi = 300, bg = "white")
```

**Explanation**:\
- A **dodged bar chart** compares the top 10 countries for solar and wind energy.\
- Data is pivoted to long format for easy faceting.\
- Gold (`#FFD700`) represents solar, blue (`#4682B4`) represents wind.

------------------------------------------------------------------------

## Plot 3: Development of Renewable Energy in Denmark vs Italy

**Question**: Do countries with higher population growth experience larger changes in energy demand?

```{r plot3}
# Filter data for Denmark and Italy and calculate renewable share
plot3 <- energy_data %>%
  filter(country %in% c("Denmark", "Italy", "Spain")) %>%
  mutate(renewable_share = solar_share_elec + wind_share_elec) %>%
  drop_na(year, renewable_share)

# Create line plot
ggplot(plot3, aes(x = year, y = renewable_share, color = country)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +  # Add points for better visibility of data points
  scale_color_manual(values = c("Denmark" = "red", "Italy" = "blue", "Spain" = "yellow")) +
  labs(title = "Renewable Energy Share (Solar + Wind) Over Time in Denmark and Italy",
       x = "Year",
       y = "Share of Electricity Generation (%)",
       color = "Country") +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 12)
  ) +
  scale_x_continuous(breaks = seq(min(plot3$year), max(plot3$year), by = 5))  # Adjust x-axis breaks

ggsave("plots/renewable_denmark_italy.png", width = 10, height = 7, dpi = 300, bg = "white")
```

**Explanation**:\
- Percentage changes in population and electricity demand are calculated over a 10-year window.\
- A **regression line** (`geom_smooth`) shows the overall trend.\
- Points represent individual countries.

------------------------------------------------------------------------

## Plot 4: Energy Consumption vs. Efficiency

**Question**: Do countries with high per capita energy consumption also have high energy efficiency?

```{r plot4}
# Calculate medians for quadrants
median_energy <- median(plot1_data$energy_per_capita, na.rm = TRUE)
median_efficiency <- median(plot1_data$energy_per_gdp, na.rm = TRUE)

ggplot(plot1_data, aes(x = energy_per_capita, y = energy_per_gdp, color = continent)) +
  geom_point() +
  geom_hline(yintercept = median_efficiency, linetype = "dashed") +
  geom_vline(xintercept = median_energy, linetype = "dashed") +
  scale_color_brewer(palette = "Set1") +
  labs(
    title = "Energy Consumption vs. Efficiency",
    x = "Energy per Capita (kWh)",
    y = "Energy per GDP (kWh/$)"
  ) +
  theme_minimal()
```

**Explanation**:\
- **Quadrant analysis** splits the plot into four regions using median values.\
- Points are colored by continent to highlight regional patterns.\
- High consumption + low efficiency (top-left quadrant) may indicate wasteful economies.

------------------------------------------------------------------------

## Plot 5: Carbon Intensity vs. Fossil Dependency

**Question**: Which countries have high carbon intensity despite low fossil fuel dependency?

```{r plot5}
plot5_data <- energy_data %>%
  filter(year == latest_year) %>%
  drop_na(carbon_intensity_elec, fossil_share_energy)

ggplot(plot5_data, aes(x = fossil_share_energy, y = carbon_intensity_elec, color = continent)) +
  geom_point() +
  geom_text_repel(
    data = subset(plot5_data, carbon_intensity_elec > 500 & fossil_share_energy < 50),
    aes(label = country), size = 3
  ) +
  scale_color_brewer(palette = "Set1") +
  labs(
    title = "Carbon Intensity vs. Fossil Fuel Dependency",
    x = "Fossil Fuel Share of Energy (%)",
    y = "Carbon Intensity (gCO₂/kWh)"
  ) +
  theme_minimal()
```

**Explanation**:\
- Outliers (e.g., countries with `carbon_intensity_elec > 500` but `fossil_share_energy < 50`) are labeled.\
- These countries may rely on coal despite having "low" fossil fuel shares.

------------------------------------------------------------------------

## Plot 6: Energy Mix by Continent

**Question**: How does the energy mix vary by continent?

```{r plot6}
plot6_data <- energy_data %>%
  filter(year == latest_year) %>%
  group_by(continent) %>%
  summarise(
    fossil = mean(fossil_share_energy, na.rm = TRUE),
    renewables = mean(renewables_share_energy, na.rm = TRUE),
    nuclear = mean(nuclear_share_energy, na.rm = TRUE)
  ) %>%
  pivot_longer(cols = -continent, names_to = "source", values_to = "share")

ggplot(plot6_data, aes(x = continent, y = share, fill = source)) +
  geom_col(position = "fill") +
  scale_fill_manual(values = c("fossil" = "#E69F00", "renewables" = "#009E73", "nuclear" = "#0072B2")) +
  labs(
    title = "Energy Mix by Continent",
    x = "",
    y = "Proportion of Energy Mix"
  ) +
  theme_minimal()
```

**Explanation**:\
- A **stacked bar chart** shows the proportional contribution of each energy source.\
- Fossil fuels dominate in some continents, while others have more balanced mixes.

------------------------------------------------------------------------

## Saving the Notebook

Render the notebook to HTML/PDF by clicking "Knit" in RStudio.
